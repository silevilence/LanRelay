@implements IDisposable

<div class="device-list-container">
    <div class="device-list-header">
        <h3>ğŸ“¡ å‘ç°çš„è®¾å¤‡</h3>
        <span class="device-count">@devices.Count å°è®¾å¤‡</span>
    </div>

    @if (devices.Count == 0)
    {
        <div class="device-list-empty">
            <div class="empty-icon">ğŸ”</div>
            <p>æ­£åœ¨æœç´¢å±€åŸŸç½‘è®¾å¤‡...</p>
            <p class="hint">ç¡®ä¿å…¶ä»–è®¾å¤‡å·²å¯åŠ¨ LanRelay</p>
        </div>
    }
    else
    {
        <div class="device-list">
            @foreach (var device in devices)
            {
                <div class="device-card @(SelectedDeviceId == device.DeviceId ? "selected" : "")"
                     @onclick="() => SelectDevice(device)">
                    <div class="device-icon">
                        @(device.IsDirectConnection ? "ğŸ’»" : "ğŸ”—")
                    </div>
                    <div class="device-info">
                        <div class="device-name">@device.DeviceName</div>
                        <div class="device-ip">@device.IPAddress</div>
                        <div class="device-group">@device.GroupId</div>
                    </div>
                    <div class="device-status">
                        @if (device.IsDirectConnection)
                        {
                            <span class="status-badge direct">ç›´è¿</span>
                        }
                        else
                        {
                            <span class="status-badge relay">ä¸­è½¬</span>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    [Inject]
    private DeviceListState DeviceListState { get; set; } = default!;

    [Parameter]
    public Guid? SelectedDeviceId { get; set; }

    [Parameter]
    public EventCallback<DeviceInfo> OnDeviceSelected { get; set; }

    private IReadOnlyList<DeviceInfo> devices = [];

    protected override void OnInitialized()
    {
        devices = DeviceListState.Devices;
        DeviceListState.OnDevicesChanged += HandleDevicesChanged;
    }

    private void HandleDevicesChanged()
    {
        devices = DeviceListState.Devices;
        InvokeAsync(StateHasChanged);
    }

    private async Task SelectDevice(DeviceInfo device)
    {
        SelectedDeviceId = device.DeviceId;
        await OnDeviceSelected.InvokeAsync(device);
    }

    public void Dispose()
    {
        DeviceListState.OnDevicesChanged -= HandleDevicesChanged;
    }
}
